{% extends "base.html" %}

{% block title %}Margin Optimizer - Home{% endblock %}

{% block content %}
<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="contracting-tab" data-bs-toggle="tab" data-bs-target="#contracting" type="button" role="tab">
            <i class="fas fa-plus-circle"></i> New Contracting
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="renewal-tab" data-bs-toggle="tab" data-bs-target="#renewal" type="button" role="tab">
            <i class="fas fa-sync-alt"></i> Renewal Analysis
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="vendor-tab" data-bs-toggle="tab" data-bs-target="#vendor" type="button" role="tab">
            <i class="fas fa-building"></i> Vendor Analysis
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="analysisTabsContent">
    
    <!-- NEW CONTRACTING TAB -->
    <div class="tab-pane fade show active" id="contracting" role="tabpanel">
        <div class="row">
            <!-- Left Column: Search Form -->
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-search"></i> Analyze Service
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="analyzeForm">
                            <div class="mb-3">
                                <label for="serviceId" class="form-label">Service ID</label>
                                <input type="text" class="form-control" id="serviceId" placeholder="e.g., RNG.5511.D023" required>
                                <div class="form-text">Enter the service ID to analyze</div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-chart-bar"></i> Analyze Service
                            </button>
                        </form>

                        <!-- Loading Spinner -->
                        <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Analyzing service...</p>
                        </div>

                        <!-- Error Alert -->
                        <div id="errorAlert" class="alert alert-danger mt-3" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="errorMessage"></span>
                        </div>

                        <!-- Quick Stats (shown after analysis) -->
                        <div id="quickStats" class="mt-4" style="display: none;">
                            <h6>Quick Stats</h6>
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Vendor Quotes
                                    <span class="badge bg-primary rounded-pill" id="statVendorQuotes">0</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Nearby Quotes
                                    <span class="badge bg-info rounded-pill" id="statNearbyQuotes">0</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    VPL Options
                                    <span class="badge bg-success rounded-pill" id="statVplOptions">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="col-lg-8">
                <!-- Welcome Message (shown initially) -->
                <div id="welcomeMessage" class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-chart-line fa-5x text-primary mb-4"></i>
                        <h3>Welcome to Margin Optimizer</h3>
                        <p class="lead">Enter a Service ID to start analyzing vendor quotes and optimizing margins</p>
                        <div class="row mt-4">
                            <div class="col-md-4">
                                <i class="fas fa-history fa-2x text-info mb-2"></i>
                                <h6>Historical Data</h6>
                                <p class="small">Analyze past negotiations</p>
                            </div>
                            <div class="col-md-4">
                                <i class="fas fa-balance-scale fa-2x text-success mb-2"></i>
                                <h6>Market Benchmark</h6>
                                <p class="small">Compare against VPL prices</p>
                            </div>
                            <div class="col-md-4">
                                <i class="fas fa-lightbulb fa-2x text-warning mb-2"></i>
                                <h6>Smart Recommendations</h6>
                                <p class="small">Get actionable strategies</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Container -->
                <div id="resultsContainer" style="display: none;">
                    <!-- Service Info -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Service Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Service ID:</strong> <span id="infoServiceId"></span></p>
                                    <p class="mb-1"><strong>Customer:</strong> <span id="infoCustomer"></span></p>
                                    <p class="mb-1"><strong>Bandwidth:</strong> <span id="infoBandwidth"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Client MRC:</strong> <span id="infoClientMrc" class="text-success fw-bold"></span></p>
                                    <p class="mb-1"><strong>Location:</strong> <span id="infoAddress"></span></p>
                                    <p class="mb-1"><strong>Coordinates:</strong> <span id="infoCoords" class="small text-muted"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vendor Quotes -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-file-invoice-dollar"></i> Vendor Quotes
                            </h5>
                            <span class="badge bg-light text-dark" id="vqCount">0</span>
                        </div>
                        <div class="card-body">
                            <div id="vendorQuotesContainer">
                                <!-- Vendor quotes will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- Nearby Vendor Quotes (within 1000m, last 12 months) -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-map-marker-alt"></i> Nearby Vendor Quotes
                                <small class="ms-2">(within 1000m, last 12 months)</small>
                            </h5>
                            <span class="badge bg-light text-dark" id="nearbyCount">0</span>
                        </div>
                        <div class="card-body">
                            <div id="nearbyQuotesContainer">
                                <!-- Nearby quotes will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- VPL Options -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list-ul"></i> Vendor Price Lists (VPL)
                            </h5>
                            <span class="badge bg-light text-dark" id="vplCount">0</span>
                        </div>
                        <div class="card-body">
                            <div id="vplOptionsContainer">
                                <!-- VPL options will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- RENEWAL TAB -->
    <div class="tab-pane fade" id="renewal" role="tabpanel">
        <div class="row">
            <!-- Left Column: Search Form -->
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-sync-alt"></i> Renewal Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="analyzeRenewalForm">
                            <div class="mb-3">
                                <label for="renewalServiceId" class="form-label">Service ID</label>
                                <input type="text" class="form-control" id="renewalServiceId" placeholder="e.g., RNG.5511.D023" required>
                                <div class="form-text">Enter the service ID for renewal analysis</div>
                            </div>

                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-chart-line"></i> Analyze Renewal
                            </button>
                        </form>

                        <!-- Loading Spinner -->
                        <div id="renewalLoadingSpinner" class="text-center mt-3" style="display: none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Analyzing renewal...</p>
                        </div>

                        <!-- Error Alert -->
                        <div id="renewalErrorAlert" class="alert alert-danger mt-3" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="renewalErrorMessage"></span>
                        </div>

                        <!-- Quick Summary (shown after analysis) -->
                        <div id="renewalQuickSummary" class="mt-4" style="display: none;">
                            <h6>Current Status</h6>
                            <div class="list-group">
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Current Vendor</small>
                                    </div>
                                    <strong id="currentVendorName">-</strong>
                                </div>
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Current MRC</small>
                                    </div>
                                    <strong id="currentMrc">-</strong>
                                </div>
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">Gross Margin</small>
                                    </div>
                                    <strong id="currentGm">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Renewal Results -->
            <div class="col-lg-8">
                <!-- VOC Line Information Card -->
                <div id="vocLineInfo" class="card shadow-sm mb-4" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-contract"></i> VOC Line Details
                        </h5>
                    </div>
                    <div class="card-body" id="vocLineInfoContent">
                        <!-- VOC Line details will be populated here -->
                    </div>
                </div>

                <!-- Renewal Results -->
                <div id="renewalResults" style="display: none;">
                    <!-- Vendor Statistics -->
                    <div id="vendorStatsSection" class="mb-4">
                        <h4><i class="fas fa-chart-bar"></i> Vendor Performance</h4>
                        <div id="vendorStatsContent">
                            <!-- Vendor stats will be populated here -->
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div id="recommendationsSection" class="mb-4">
                        <h4><i class="fas fa-lightbulb"></i> Renewal Recommendations</h4>
                        <div id="recommendationsList">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>

                    <!-- VPL Options for Current Vendor -->
                    <div id="renewalVplSection" class="mb-4" style="display: none;">
                        <h4><i class="fas fa-list"></i> Available VPL Options</h4>
                        <div id="renewalVplList">
                            <!-- VPL options will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VENDOR ANALYSIS TAB -->
    <div class="tab-pane fade" id="vendor" role="tabpanel">
        <div class="row">
            <!-- Left Column: Vendor Search -->
            <div class="col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-building"></i> Vendor Search
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="analyzeVendorForm">
                            <div class="mb-3">
                                <label for="vendorName" class="form-label">Vendor Name</label>
                                <input type="text" class="form-control" id="vendorName" placeholder="Start typing vendor name..." autocomplete="off" required>
                                <div class="form-text">Search for vendor by name</div>
                                <!-- Autocomplete dropdown -->
                                <div id="vendorAutocomplete" class="list-group position-absolute" style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto; width: calc(100% - 48px);"></div>
                            </div>

                            <button type="submit" class="btn btn-info w-100">
                                <i class="fas fa-search"></i> Analyze Vendor
                            </button>
                        </form>

                        <!-- Loading Spinner -->
                        <div id="vendorLoadingSpinner" class="text-center mt-3" style="display: none;">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading vendor data...</p>
                        </div>

                        <!-- Error Alert -->
                        <div id="vendorErrorAlert" class="alert alert-danger mt-3" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="vendorErrorMessage"></span>
                        </div>

                        <!-- Quick Summary -->
                        <div id="vendorQuickSummary" class="mt-4" style="display: none;">
                            <h6>Summary</h6>
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Renewals
                                    <span class="badge bg-success rounded-pill" id="statRenewals">0</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    New Contracts
                                    <span class="badge bg-primary rounded-pill" id="statNewContracts">0</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    Avg Discount
                                    <span class="badge bg-info rounded-pill" id="statAvgDiscount">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Vendor Results -->
            <div class="col-lg-8">
                <!-- Welcome Message -->
                <div id="vendorWelcomeMessage" class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-building fa-5x text-info mb-4"></i>
                        <h3>Vendor Historical Analysis</h3>
                        <p class="lead">Search for a vendor to view their historical performance</p>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <i class="fas fa-sync-alt fa-2x text-success mb-2"></i>
                                <h6>Renewal History</h6>
                                <p class="small">Track renewal success rates and discounts</p>
                            </div>
                            <div class="col-md-6">
                                <i class="fas fa-plus-circle fa-2x text-primary mb-2"></i>
                                <h6>New Contract History</h6>
                                <p class="small">View new contracting patterns</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Results -->
                <div id="vendorResults" style="display: none;">
                    <!-- Vendor Info Header -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-building"></i> <span id="vendorDisplayName"></span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <h3 class="text-success" id="totalRenewals">0</h3>
                                    <p class="text-muted mb-0">Total Renewals</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 class="text-primary" id="totalNewContracts">0</h3>
                                    <p class="text-muted mb-0">New Contracts</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 class="text-info" id="avgDiscountRate">0%</h3>
                                    <p class="text-muted mb-0">Avg Discount</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 class="text-warning" id="successRate">0%</h3>
                                    <p class="text-muted mb-0">Success Rate</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Renewal History -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-sync-alt"></i> Renewal History
                            </h5>
                            <span class="badge bg-light text-dark" id="renewalHistoryCount">0</span>
                        </div>
                        <div class="card-body">
                            <div id="renewalHistoryContainer">
                                <!-- Renewal history will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- New Contract History -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-plus-circle"></i> New Contract History
                            </h5>
                            <span class="badge bg-light text-dark" id="newContractHistoryCount">0</span>
                        </div>
                        <div class="card-body">
                            <div id="newContractHistoryContainer">
                                <!-- New contract history will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Strategy Modal (for New Contracting tab) -->
<div class="modal fade" id="strategyModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-chess"></i> Negotiation Strategy
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Loading -->
                <div id="strategyLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Generating negotiation strategy...</p>
                </div>

                <!-- Strategy Content -->
                <div id="strategyContent" style="display: none;">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
